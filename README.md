# Система аудиосопровождения фильмов для слабовидящих людей

## Описание

Мы разработали систему, которая дополняет тишину во время просмотра фильма комментариями от Искусственного Интеллекта посредством мультимодального анализа кадров. Это позволяет получить схожий опыт от просмотра фильма людям как с нарушениями зрения так и без.

Созданная мультимодальная система использует различные нейросети заточенные под решение конкретных задач. Таким образом она остается легко расширяемой и достаточно точной.

### Алгоритм простыми словами

1. Распознаем что на картинке. Описываем детали.
2. Если видим человека, пытаемся узнать персонажа, а так же его эмоцию.
3. Используем текстовую модель которая соединяет факты в лаконичное описание.
4. Преобразуем ответ в человеческую речь.
5. Добавляем аудиодорожку в стрим или файл

### Ключевые особенности нашего решения

- Несколько типов рассказчиков
    - Светский монолог или рок звезда? Выбери компанию под фильм. 
    - Данный функционал, например, позволит ребенку смотреть фильмы в компании рассказчика ориентированного на общение с молодым человеком и учитывающего его особенности восприятия. 
- Поддержка как стримовой обработки так и предобработки
    - поскольку некоторые фильмы могут потребовать модерации сгенерированных аудио-субтитров мы так же поддержали режим  предобработки, где могут быть дополнены шаги по созданию субтитров элементами коррекции текста и цензурой.
    - тем не менее real-time аудио-субтитры является нашим основным функционалом, что достигается посредством покадровой обработки сюжета и дальнейшего его стриминга в клиент;
- Приложение под любой экран! - Абсолютная кросплатформенность
    - смарт тв (протестировано на телевизоре samsung)
    - веб браузер (протестировано Chrome/Safari/Yandex)
    - android
    - ios
- Распознание эмоций героев
    - благодаря мульти-модульности ИИ мы смогли уделить внимание и сделать более точное описание сюжета выделяя эмоции людей;
- Сопоставление героев фильма с сюжетом
    - так же с помощью мульти-модульности мы смогли описывать не только в общих словах, но и сопостовлять кадры с актерским составом чтобы точно указывать кто в кадре.
- Из коробки
    - наше решение предоставляет возможность дополнять стрим и обрабатывать на лету в Стрим Сервисе, так что не придется выпускать специальные версии фильмов.

### Схема BPMN
![](https://i.imgur.com/13OOMvH.png)

### Sequence Diagram (упрощенный вариант поведения)

```sequence
Пользователь->Сервер: Я хочу посмотреть фильм с аудиосубтирами.
Сервер-->Пользователь: Вот видеострим
Пользователь->Сервер: Отлично!
```

### Необходимые ресурсы

Для создания аудиосубтитров мы используем нейросети, которые требуют следующие ресурсы:

Дисковое пространство: веса для нейросети требуют места, как и сгенерированные субтитры и голосовая запись.Однако, в сравнении с весом самих фильмов, это сравнительно малый объем.

Вычислительная мощность: обработка фильма нейросетью требует значительных вычислительных ресурсов, однако, они требуются лишь при первом стриминговом просмотре фильма или во время предварительной обработки. В дальнейшем, благодаря буферизации и сохранению результата работы, нагрузка будет на том же уровне что и при просмотре фильма без сопровождения.

Пропускная способность: для стримингового сервиса очень важна доступность трансляции для всех пользователей. Обработка на лету подразумевает, что алгоритм будет тоже “смотреть” трансляцию, это необходимо единожды для каждого фрагмента фильма, так что пиковая нагрузка будет если N откроют разные временные отрезки в новом (необработанном) фильме. Тогда нагрузка на сеть будет  2N. Однако, будем объективны, зритель, наиболее часто, смотрит фильм последовательно и, особенно по отношении к новому фильму, такая ситуация маловероятна.

Тренировочные данные: для улучшения точности распознавания, необходим значительный набор тестовых данных. Это опционально, по желанию площадки. 

Работа модераторов: результат работы искусственный интеллект не гарантированно соответствует ожидаемому. Несмотря на то, что можно очень тонко и грамотно настроить результат, модерация рекомендуема.

Стоимость: ресурсы указанные выше необходимо приобретать или поддерживать, так что, возможно, услугу по созданию аудиосопровождения имеет смысл предоставлять к определенному набору фильмов.


### Маштабирование проекта

Расширение работы сервиса может быть достигнуто благодаря следующим подходам:
горизонтальное расширение - добавление новых серверов, балансировка нагрузки между ними
Инфраструктура в облаке - аренда роя серверов, количество которых варьируется для достижения максимальных результатов и минимума простоя. 
контейнеризация (микросервисы) - максимизирует использование ресурсов каждого конкретного сервера
Кеш - сохранение результатов работы, значительно сокращает количество вычисления


### Подключенные элементы Искусственного Интеллекта

К проекту были подключены модели: 
* для распознавания лиц и соотнесения их с лицами известных заранее персонажей
* определения эмоций героев
* генеративные трансформеры для преобразования типа image2text (описание происходящего на сцене), модели взяты с hugging face
* генеративный трансформер для преобразования типа text2text (перефразирование происходящего на сцене с учётом героев, их эмоций, возраста). Подключено api ChatGPT 3, без перевода с английского языка
* типа text2speech для генерации озвучивания сцен в аудиоформате из сгенерированного описания сцены.

Соответствующий pipeline (конвеер) генерации озвучивания сцен:
1. Выбор кадра
2. Детекция лиц и происходящего на кадре (image2text модели)
3. Обработка промпта с данными, полученными на этапе 2, при помощи text2text
4. Генерация файла субтитров .srt с таймштампами
5. Генерация озвучивания фраз из субтитров в необходимые моменты времени при помощи text2speech
6. Слияние потоков аудио и видео во фрагмент соответствующего формата

Обработка одного кадра видео создаёт задержку 40 +- 2 мсек, из-за чего было принято решение обрабатывать видео фрагментами заранее, а также кэшировать текстовый формат субтитров для дублирующей озвучки. При сохранении фрагмента накладываются две аудиодорожки с amix фильтром, что позволяет не приглушать искуственно ни одну из дорожек. Обработка кадров производится раз в фиксированное количество секунд (по умолчанию = 3), остальные кадры пропускаются.
Озвучивание сцен рассчитано на конкретные моменты времени и реплики вставляются с перерывами, если время нужного кадра не подошло.


## Техническая эффективность

Сервис работает в режиме стриминга, **задержка 42-76ms** (dпри использовании локально поднятых текстовых моделей), но появляется только в начале или при слабом интернете, в дальнейшем видео буфиризируется , опыт как на youtube. Так же возможна предобработка, при этом менять исходный файл фильма нет необхомости, мы написали кастомный плеер в котором возможно использовать отдельный аудиопоток.
